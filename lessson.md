---
title: "Polkit Privilege Escalation"
teaching: 3
exercises: 30
questions:
- "What is Polkit?"
- "How the Exploit Works"
objectives:
- "Understand the Role and Function of Polkit"
- "Identify the Vulnerability"
- "Recognize the Exploitation Process"
---


## What is Polkit?

Polkit is integral to numerous Linux distributions for managing system-wide permissions. The CVE-2021-3560 vulnerability exploits Polkit's functionality, enabling local users to escalate their privileges and achieve root access. This unauthorized elevation can lead to complete system control, enabling attackers to perform further malicious activities. The root cause of this vulnerability lies in a defect within Polkit’s authentication mechanism, which allows the bypassing of the authentication step needed for root access acquisition. Mitigation of this security flaw involves updating the operating system and ensuring that the Polkit version is updated beyond 0.118.

Originally known as PolicyKit, Polkit serves as an intermediary allowing various applications to communicate and execute processes via D-bus, a middleware that facilitates inter-process communication. It enables both privileged (sudo) and non-privileged processes to interact, providing a unified control interface for managing system-wide permissions. For instance, executing the ‘pkexec’ command in a Linux terminal typically triggers a graphical interface prompt for sudo authentication. Conversely, operating Polkit via command-line interfaces permits direct interaction without a graphical user interface.

## Details on How the Exploit Works

The attack is executed through the transmission of a sequence of meticulously constructed D-bus messages directed at Polkit, aimed at inducing a race condition. This condition erroneously issues an authorization message, circumventing the standard authentication procedure. Additionally, the assault leverages the XDG_RUNTIME_DIR environment variable, which delineates the location where Polkit archives its authentication-specific files and tokens. Unauthorized entry into this directory facilitates access to the system without authentication. The success of this exploit significantly depends on timing; therefore, multiple attempts and a rapid succession of requests are essential to increase the likelihood of a successful breach.

## What are the countermeasures?

1. Update and Patch Systems: Regularly update the operating system and all associated packages to ensure that the Polkit component is beyond the vulnerable versions. Specifically, ensure Polkit is updated to version 0.118 or higher, which addresses this specific vulnerability.

2. Monitor System Activity: Implement comprehensive monitoring of system activities, particularly focusing on authentication processes and system privilege escalations. Use intrusion detection systems (IDS) and log management solutions to detect and alert on unusual activities that could indicate an attempted exploitation of the Polkit vulnerability.

3. Restrict Access to Sensitive Directories: Limit access to critical system directories and environment variables, such as XDG_RUNTIME_DIR, which are known to be leveraged in the CVE-2021-3560 exploit. Employ filesystem permissions and access control lists (ACLs) to restrict unauthorized users from accessing or modifying these directories and files.

### Demonstration
1. We will start by first adding the Polkit Privilege Escalation application:

![polkit escalation](https://github.com/markyu0401/CVE-2021-3560-Polkit-Privilege-Escalation/assets/60618569/389a5c69-5b79-469e-b7a3-f8d47bf03668)

2. Next, click the View link to go to the application-specific page and start the application containers:

![polkit start up](https://github.com/markyu0401/CVE-2021-3560-Polkit-Privilege-Escalation/assets/60618569/54d40152-45ce-4b80-82da-7002f7f5db04)

3. Open the terminal and type start with start.sh to remove stale PID file /var/run/dbus/pid. and startsystem message bus dbus.

![start_sh](https://github.com/markyu0401/CVE-2021-3560-Polkit-Privilege-Escalation/assets/60618569/c1dc0b65-67d1-4447-91d7-6e3273e9dc60)\

4. Copy these code in to the terminal, this step finds the time it takes a command to finish. Ensure that the outputted times are written
down.:

   ```
   time dbus-send --system --dest=org.freedesktop.Accounts --type=method_call --print-reply /org/freedesktop/Accounts org.freedesktop.Accounts.CreateUser string:samurai string:"Samurai" int32:1
   ```
![find_time](https://github.com/markyu0401/CVE-2021-3560-Polkit-Privilege-Escalation/assets/60618569/0a5f41af-9620-4767-bd1f-51fe6b4b593c)

taking in account the “real” time, half it to get the half time it takes to run the dbus query. The
reason for halving is because we want the process to be interrupted in the middle (when the process is still
being worked on at the server level). In the command ensure to change the X.XXX time to half of the
“real” time. You may need to run the command a couple of times as it may not work the first time. The
following is the template command:
5. 



